{% extends "base.html" %}
{% block content %}

<h3 class="todo">todo</h3>

<!-- Task Form -->
<form id="todo-form">
    <input type="text" name="task" placeholder="new task">
    <button type="submit">add</button>
</form>

<!-- Active Tasks -->
<h3>active tasks</h3>
<ul class="todolist active-tasks"></ul>

<!-- Completed Tasks -->
<h3>completed tasks</h3>
<ul class="todolist completed-tasks"></ul>

<!-- JavaScript -->
<script>
    // Function to prevent page reload on form submission
    document.getElementById('todo-form').addEventListener('submit', function(event) {
        event.preventDefault();
        addTask();
    });

    // Add task via AJAX and update the UI
    async function addTask() {
        const taskInput = document.querySelector('input[name="task"]');
        const task = taskInput.value;
        if (task) {
            const response = await fetch('/add_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task }),
            });

            const result = await response.json();
            if (result.success) {
                // Dynamically add the new task to the active tasks list
                const newTaskHTML = `
                    <li data-task-id="${result.id}">
                        <div class="task-wrapper">
                            <div class="main-taskbar">
                                <button class="toggle-task" data-task-id="${result.id}">${result.completed ? 'x' : '‚†Ä'}</button>
                                <span class="task-name">${result.task}</span>
                                <button class="delete-task" data-task-id="${result.id}">üóëÔ∏è</button>
                                <button class="add-subtask" data-task-id="${result.id}">‚ûï</button>
                            </div>
                            <ul class="subtasks">
                            </ul>
                        </div>
                    </li>`;
                document.querySelector('ul.active-tasks').insertAdjacentHTML('beforeend', newTaskHTML);
                taskInput.value = ''; // Clear the input after adding the task
            }
        }
    }

    // Toggle task completion and move it to the appropriate section without reloading the page
    async function toggleTask(taskId) {
        const response = await fetch(`/toggle_task/${taskId}`, { method: 'POST' });
        const result = await response.json();
        if (result.success) {
            const taskElement = document.querySelector(`li[data-task-id="${taskId}"]`);
            taskElement.classList.toggle('completed', result.completed);

            // Move task between active and completed sections based on its completion status
            if (result.completed) {
                document.querySelector('.completed-tasks').insertAdjacentElement('afterbegin', taskElement);
            } else {
                document.querySelector('.active-tasks').appendChild(taskElement);
            }

            const toggleButton = taskElement.querySelector('.toggle-task');
            toggleButton.innerText = result.completed ? 'x' : '‚†Ä';
        }
    }

    // üóëÔ∏è task via AJAX and remove from UI
    async function deleteTask(taskId) {
        const response = await fetch(`/delete_task/${taskId}`, { method: 'POST' });
        const result = await response.json();
        if (result.success) {
            document.querySelector(`li[data-task-id="${taskId}"]`).remove();
        }
    }

    // Edit task name via AJAX
    async function editTask(taskId) {
        const taskElement = document.querySelector(`li[data-task-id="${taskId}"] .task-name`);

        // Make the task name element directly editable
        taskElement.contentEditable = true;
        taskElement.focus(); // Focus on the element for editing

        // Save changes on blur or Enter
        const handleBlurOrEnter = async () => {
            const newName = taskElement.innerText;
            if (newName) {
                const response = await fetch(`/edit_task/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: newName }),
                });
                const result = await response.json();
                if (result.success) {
                    taskElement.contentEditable = false; // Disable editing after saving
                }
            }
        };

        taskElement.addEventListener('blur', handleBlurOrEnter);
        taskElement.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent adding a new line
                handleBlurOrEnter();
            }
        });
    }


    // Add, toggle, and delete subtasks similar to tasks
    async function addSubtask(taskId) {
        const subtaskName = prompt("New subtask:");
        if (subtaskName) {
            const response = await fetch(`/add_subtask/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subtask: subtaskName }),
            });
            const result = await response.json();
            if (result.success) {
                const subtaskList = document.querySelector(`li[data-task-id="${taskId}"] .subtasks`);
                const newSubtaskHTML = `
                    <li data-subtask-id="${result.subtask_id}">
                        <button class="toggle-subtask" data-subtask-id="${result.subtask_id}">‚†Ä</button>
                        <span class="subtask-name">${result.subtask}</span>
                        <button class="delete-subtask" data-subtask-id="${result.subtask_id}">üóëÔ∏è</button>
                    </li>`;
                subtaskList.insertAdjacentHTML('beforeend', newSubtaskHTML);
            }
        }
    }

    async function toggleSubtask(subtaskId) {
        const response = await fetch(`/toggle_subtask/${subtaskId}`, { method: 'POST' });
        const result = await response.json();
        if (result.success) {
            const subtaskElement = document.querySelector(`li[data-subtask-id="${subtaskId}"]`);
            subtaskElement.classList.toggle('completed', result.completed);
            const toggleButton = subtaskElement.querySelector('.toggle-subtask');
            toggleButton.innerText = result.completed ? 'x' : '‚†Ä';
        }
    }

    async function deleteSubtask(subtaskId) {
        const response = await fetch(`/delete_subtask/${subtaskId}`, { method: 'POST' });
        const result = await response.json();
        if (result.success) {
            document.querySelector(`li[data-subtask-id="${subtaskId}"]`).remove();
        }
    }

    async function editSubtask(subtaskId) {
        const subtaskElement = document.querySelector(`li[data-subtask-id="${subtaskId}"] .subtask-name`);

        subtaskElement.contentEditable = true;
        subtaskElement.focus();

        const handleBlurOrEnter = async () => {
            const newName = subtaskElement.innerText;
            if (newName) {
                const response = await fetch(`/edit_subtask/${subtaskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: newName }),
                });
                const result = await response.json();
                if (result.success) {
                    subtaskElement.contentEditable = false;
                }
            }
        };

        subtaskElement.addEventListener('blur', handleBlurOrEnter);
        subtaskElement.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleBlurOrEnter();
            }
        });
    }

    // Event delegation for task/subtask actions
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('toggle-task')) {
            const taskId = event.target.getAttribute('data-task-id');
            toggleTask(taskId);
        }
        if (event.target.classList.contains('delete-task')) {
            const taskId = event.target.getAttribute('data-task-id');
            deleteTask(taskId);
        }
        if (event.target.classList.contains('task-name')) { // Handle clicks on task names
            const taskId = event.target.closest('li').getAttribute('data-task-id');
            editTask(taskId);
        }
        if (event.target.classList.contains('add-subtask')) {
            const taskId = event.target.getAttribute('data-task-id');
            addSubtask(taskId);
        }
        if (event.target.classList.contains('toggle-subtask')) {
            const subtaskId = event.target.getAttribute('data-subtask-id');
            toggleSubtask(subtaskId);
        }
        if (event.target.classList.contains('subtask-name')) { // Handle clicks on subtask names
            const subtaskId = event.target.closest('li').getAttribute('data-subtask-id');
            editSubtask(subtaskId);
        }
        if (event.target.classList.contains('delete-subtask')) {
            const subtaskId = event.target.getAttribute('data-subtask-id');
            deleteSubtask(subtaskId);
        }
    });

    // Fetch and display tasks when the page loads
    async function fetchTasks() {
        const response = await fetch('/fetch_tasks');
        const result = await response.json();

        if (result.success) {
            // Clear current task list
            document.querySelector('ul.active-tasks').innerHTML = '';
            document.querySelector('ul.completed-tasks').innerHTML = '';

            result.todos.forEach(task => {
                let taskHTML = `
                    <li data-task-id="${task.id}">
                        <div class="task-wrapper">
                            <div class="main-taskbar">
                                <button class="toggle-task" data-task-id="${task.id}">${task.completed ? 'x' : '‚†Ä'}</button>
                                <span class="task-name">${task.task}</span>
                                <button class="delete-task" data-task-id="${task.id}">üóëÔ∏è</button>
                                <button class="add-subtask" data-task-id="${task.id}">‚ûï</button>
                            </div>
                            <ul class="subtasks">
                                ${task.subtasks.map(subtask => `
                                    <li data-subtask-id="${subtask.id}">
                                        <button class="toggle-subtask" data-subtask-id="${subtask.id}">${subtask.completed ? 'x' : '‚†Ä'}</button>
                                        <span class="subtask-name ${subtask.completed ? 'completed' : ''}">${subtask.name}</span>
                                        <button class="delete-subtask" data-subtask-id="${subtask.id}">üóëÔ∏è</button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </li>`;

                // Append to correct section (active or completed)
                if (task.completed) {
                    document.querySelector('ul.completed-tasks').insertAdjacentHTML('beforeend', taskHTML);
                } else {
                    document.querySelector('ul.active-tasks').insertAdjacentHTML('beforeend', taskHTML);
                }
            });
        }
    }

    // Fetch tasks when the page loads
    window.onload = fetchTasks;

</script>

{% endblock %}