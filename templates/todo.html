{% extends "base.html" %}
{% block content %}
<h2>To-Do List</h2>
<form id="todo-form">
    <input type="text" name="task" placeholder="New Task">
    <button type="submit">Add</button>
</form>
<ul class="todolist">
    {% for todo in todos %}
    <li class="{{ 'completed' if todo.completed else '' }}">
        <button onclick="toggleTask({{ todo.id }})">{{ '✔' if todo.completed else '✖' }}</button>
        {{ todo.task }}
        <button onclick="deleteTask({{ todo.id }})">Delete</button>
    </li>
    {% endfor %}
</ul>

<script>
    // Function to add a new task
    async function addTask() {
        const taskInput = document.querySelector('input[name="task"]');
        const task = taskInput.value;
        if (task) {
            const response = await fetch('/add_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task }),
            });

            const result = await response.json();
            if (result.success) {
                const newTaskHTML = `
                    <li>
                        <button onclick="toggleTask(${result.id})">${result.completed ? '✔' : '✖'}</button>
                        ${result.task}
                        <button onclick="deleteTask(${result.id})">Delete</button>
                    </li>`;
                // Insert the new task at the top of the list
                document.querySelector('ul.todolist').insertAdjacentHTML('afterbegin', newTaskHTML);
                taskInput.value = '';  // Clear the input field
            }
        }
    }

    // Function to toggle task completion
    async function toggleTask(taskId) {
        const response = await fetch(`/toggle_task/${taskId}`, {
            method: 'POST',
        });

        const result = await response.json();
        if (result.success) {
            const button = document.querySelector(`button[onclick="toggleTask(${taskId})"]`);
            button.innerText = result.completed ? '✔' : '✖';
            const taskElement = button.parentElement;
            taskElement.classList.toggle('completed', result.completed);
            moveTask(taskElement, result.completed);  // Move the task in the list
        }
    }

    // Function to delete a task
    async function deleteTask(taskId) {
        const response = await fetch(`/delete_task/${taskId}`, {
            method: 'POST',
        });

        const result = await response.json();
        if (result.success) {
            const taskElement = document.querySelector(`button[onclick="deleteTask(${taskId})"]`).parentElement;
            taskElement.remove();  // Remove the task from the DOM
        }
    }

    // Function to move a task in the list based on completion status
    function moveTask(taskElement, isCompleted) {
        const list = document.querySelector('ul.todolist');
        if (isCompleted) {
            // Move the task to the bottom of the list if completed
            list.appendChild(taskElement);
        } else {
            // Move the task to the top of the list if not completed
            list.insertBefore(taskElement, list.firstChild);
        }
    }

    // Attach event listener to the form submission for adding tasks
    document.querySelector('form').addEventListener('submit', function(event) {
        event.preventDefault();  // Prevent the form from reloading the page
        addTask();
    });
</script>
{% endblock %}